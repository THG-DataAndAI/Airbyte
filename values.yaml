global:
  serviceAccountName: airbyte
  deploymentMode: oss
  configMapName: airbyte-airbyte-env
  secretName: airbyte-airbyte-secrets
  auth:
    enabled: true
    initialUser:
      # These will be overridden by helm command line values
      email: admin@airbyte.io 
      password: changeme

  database:
    secretName: airbyte-db-secrets
    secretValue: DATABASE_PASSWORD
    host: airbyte-db-postgresql
    port: "5432"
    database: airbyte
    user: airbyte
    password: ""  # This will be overridden by secretName/secretValue
  logs:
    accessKey:
      password: minio
      existingSecret: ""
      existingSecretKey: ""
    secretKey:
      password: minio123
      existingSecret: ""
      existingSecretKey: ""

webapp:
  enabled: true
  replicaCount: 1
  service:
    type: ClusterIP
    port: 80
  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/proxy-body-size: "0"
      nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    hosts:
      - host: airbyte.thg-reporting.com
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: airbyte-tls
        hosts:
          - airbyte.thg-reporting.com
  env:
    - name: INTERNAL_API_HOST
      value: airbyte-server-svc:8001

server:
  enabled: true
  replicaCount: 1
  service:
    type: ClusterIP
    port: 8001
  env:
    - name: TRACKING_STRATEGY
      value: "segment"
    - name: AIRBYTE_VERSION
      value: "0.50.0"
    - name: CONFIG_DATABASE_USER
      value: "airbyte"
    - name: CONFIG_DATABASE_PASSWORD
      valueFrom:
        secretKeyRef:
          name: airbyte-db-secrets
          key: DATABASE_PASSWORD
    - name: CONFIG_DATABASE_URL
      value: "jdbc:postgresql://airbyte-db-postgresql:5432/airbyte"
    - name: TEMPORAL_HOST
      value: "airbyte-temporal:7233"
    - name: INTERNAL_API_HOST
      value: "airbyte-server-svc:8001"

worker:
  enabled: true
  replicaCount: 2
  env:
    - name: SYNC_JOB_MAX_ATTEMPTS
      value: "3"
    - name: SYNC_JOB_MAX_TIMEOUT_DAYS
      value: "3"
    - name: INTERNAL_API_HOST
      value: "airbyte-server-svc:8001"
    - name: TEMPORAL_HOST
      value: "airbyte-temporal:7233"
    - name: DATABASE_USER
      value: "airbyte"
    - name: DATABASE_PASSWORD
      valueFrom:
        secretKeyRef:
          name: airbyte-db-secrets
          key: DATABASE_PASSWORD
    - name: DATABASE_URL
      value: "jdbc:postgresql://airbyte-db-postgresql:5432/airbyte"

airbyte-bootloader:
  enabled: true
  env:
    - name: DATABASE_USER
      value: "airbyte"
    - name: DATABASE_PASSWORD
      valueFrom:
        secretKeyRef:
          name: airbyte-db-secrets
          key: DATABASE_PASSWORD
    - name: DATABASE_URL
      value: "jdbc:postgresql://airbyte-db-postgresql:5432/airbyte"

temporal:
  enabled: true
  replicaCount: 1
  env:
    - name: DB
      value: "postgresql"
    - name: DB_PORT
      value: "5432"
    - name: POSTGRES_USER
      value: "airbyte"
    - name: POSTGRES_PWD
      valueFrom:
        secretKeyRef:
          name: airbyte-db-secrets
          key: DATABASE_PASSWORD
    - name: POSTGRES_SEEDS
      value: "airbyte-db-postgresql"
    - name: DYNAMIC_CONFIG_FILE_PATH
      value: "config/dynamicconfig/development.yaml"

postgresql:
  enabled: false  # We'll use external PostgreSQL

externalDatabase:
  host: airbyte-db-postgresql
  port: 5432
  database: airbyte
  user: airbyte
  password: ""  # Will use existingSecret instead
  existingSecret: airbyte-db-secrets
  existingSecretPasswordKey: DATABASE_PASSWORD

minio:
  enabled: true
  auth:
    rootUser: minio
    rootPassword: minio123

# Pod annotations for service mesh/network policy
podAnnotations:
  sidecar.istio.io/inject: "false"  # Disable istio sidecar if present

# Service accounts
serviceAccount:
  create: false  # We already create it manually
  name: airbyte

# Resource limits
resources:
  limits:
    cpu: 1000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 1Gi

# Pod disruption budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Enable pod-to-pod communication
global:
  jobs:
    resources:
      limits:
        cpu: 1000m
        memory: 2Gi
      requests:
        cpu: 500m
        memory: 1Gi
  
# Connector builder server
connector-builder-server:
  enabled: true
  service:
    type: ClusterIP
    port: 80

# API server configuration
api-server:
  enabled: true
  service:
    type: ClusterIP
    port: 8006
  env:
    - name: INTERNAL_API_HOST
      value: "airbyte-server-svc:8001"
    - name: CONNECTOR_BUILDER_SERVER_API_HOST
      value: "airbyte-connector-builder-server-svc:80"

# Cron jobs
cron:
  enabled: true
  env:
    - name: INTERNAL_API_HOST
      value: "airbyte-server-svc:8001"
