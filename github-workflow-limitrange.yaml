# Add this step to your GitHub workflow AFTER the Helm deployment step

- name: Apply Kubernetes LimitRange for Container Resources
  run: |
    echo "Applying LimitRange to enforce resource limits..."
    
    # Create the LimitRange YAML
    cat <<EOF | kubectl apply -f -
    apiVersion: v1
    kind: LimitRange
    metadata:
      name: airbyte-container-limits
      namespace: airbyte
    spec:
      limits:
      # Default limits for all containers in the namespace
      - default:
          cpu: "2"
          memory: "4Gi"
        defaultRequest:
          cpu: "500m"
          memory: "1Gi"
        # Maximum limits a container can request
        max:
          cpu: "4"
          memory: "8Gi"
        # Minimum limits a container must request
        min:
          cpu: "100m"
          memory: "128Mi"
        type: Container
      # Pod-level limits
      - max:
          cpu: "16"
          memory: "32Gi"
        type: Pod
    EOF
    
    echo "âœ… LimitRange applied successfully!"
    
    # Note: Only new pods will get these limits
    echo "Note: Only new replication job pods will use these resource limits."